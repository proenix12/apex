<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Legends Heirloom Shard Analyzer & Community Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .chart-container { position: relative; width: 100%; margin-left: auto; margin-right: auto; }
        .stat-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .progress-bar-bg { background-color: #e5e7eb; border-radius: 0.375rem; overflow: hidden; height: 1.5rem; }
        .progress-bar-fill { background-color: #0284c7; /* sky-600 */ height: 100%; transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: 600; line-height: 1.5rem; }
        .tooltip { position: absolute; background-color: rgba(0,0,0,0.8); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.875rem; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05); }
        .submit-button { background-color: #10b981; /* emerald-500 */ color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .submit-button:hover { background-color: #059669; /* emerald-600 */ }
        .info-box { background-color: #eff6ff; border-left-width: 4px; border-color: #3b82f6; padding: 1rem; } /* blue-50, blue-500 */
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="container mx-auto max-w-4xl bg-white shadow-xl rounded-lg p-6 md:p-10">

        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-sky-700">Apex Legends Heirloom Shard Analyzer ‚ú®</h1>
            <p class="mt-2 text-slate-600">Estimate your pack count, understand your chances, see community stats, and contribute your data!</p>
        </header>

        <section id="calculator" class="mb-8 md:mb-12">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6">Your Heirloom Journey Tracker üó∫Ô∏è</h2>
            <p class="mb-6 text-slate-700">Enter your current Apex Legends player level and the number of regular Apex Packs you've purchased. This tool will estimate your total packs opened and show how close you are to the 500-pack pity guarantee. Packs from Battle Passes or special events (that grant standard Apex Packs) can also be added if you've tracked them.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="playerLevel" class="block text-sm font-medium text-slate-700 mb-1">Your Player Level (1-500+):</label>
                    <input type="number" id="playerLevel" name="playerLevel" min="1" value="1" class="form-input">
                </div>
                <div>
                    <label for="purchasedPacks" class="block text-sm font-medium text-slate-700 mb-1">Purchased Regular Apex Packs:</label>
                    <input type="number" id="purchasedPacks" name="purchasedPacks" min="0" value="0" class="form-input">
                </div>
                <div>
                    <label for="otherPacks" class="block text-sm font-medium text-slate-700 mb-1">Other Regular Packs (Battle Pass, etc.):</label>
                    <input type="number" id="otherPacks" name="otherPacks" min="0" value="0" class="form-input">
                </div>
            </div>
             <button id="calculateButton" class="w-full md:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-6 rounded-md shadow-md transition duration-150 ease-in-out">Calculate My Progress</button>
            <div id="results" class="mt-8 space-y-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-slate-500 mb-1">Packs from Leveling</h3>
                        <p id="packsFromLevel" class="text-3xl font-bold text-sky-600">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-slate-500 mb-1">Total Estimated Packs Opened</h3>
                        <p id="totalPacksOpened" class="text-3xl font-bold text-sky-600">0</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">Progress to 500-Pack Pity Guarantee:</h3>
                    <div class="progress-bar-bg">
                        <div id="progressBarFill" class="progress-bar-fill" style="width: 0%;">0%</div>
                    </div>
                    <p id="packsToPity" class="text-sm text-slate-600 mt-2 text-center">You are <span class="font-bold">500</span> packs away from the guarantee.</p>
                </div>
                <div class="stat-card">
                     <h3 class="text-lg font-semibold text-slate-700 mb-2">Your Current Random Chance:</h3>
                     <p id="randomChanceText" class="text-slate-600">Calculating...</p>
                </div>
            </div>
        </section>

        <section id="submitDataSection" class="mb-8 md:mb-12 stat-card">
            <h2 class="text-2xl font-semibold text-emerald-600 mb-6">Contribute Your Heirloom Data! üìã</h2>
            <p class="mb-4 text-slate-700">Help the community understand Heirloom Shard statistics better! If you've received Heirloom Shards, please submit your data. This information will be added to a public Google Sheet to generate community statistics.</p>
            
            <form id="heirloomDataForm" class="space-y-4">
                <div>
                    <label for="submitLevel" class="block text-sm font-medium text-slate-700">Player Level When Shards Received:</label>
                    <input type="number" id="submitLevel" name="entry.YOUR_LEVEL_FIELD_ID" min="1" required class="form-input mt-1">
                </div>
                <div>
                    <label for="submitPacksOpened" class="block text-sm font-medium text-slate-700">Estimated Total Packs Opened When Shards Received:</label>
                    <input type="number" id="submitPacksOpened" name="entry.YOUR_PACKS_FIELD_ID" min="1" required class="form-input mt-1">
                </div>
                <div>
                    <label for="submitHitPity" class="block text-sm font-medium text-slate-700">Did you hit the 500-pack pity guarantee?</label>
                    <select id="submitHitPity" name="entry.YOUR_PITY_FIELD_ID" required class="form-input mt-1">
                        <option value="">--Please choose an option--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Unsure">Unsure</option>
                    </select>
                </div>
                <div>
                    <label for="submitDate" class="block text-sm font-medium text-slate-700">Date Received (Optional):</label>
                    <input type="date" id="submitDate" name="entry.YOUR_DATE_FIELD_ID" class="form-input mt-1">
                </div>
                <button type="submit" class="submit-button">Submit My Heirloom Data</button>
            </form>
            <p id="formSubmissionStatus" class="mt-4 text-sm"></p>
            <div class="info-box mt-6">
                <p class="text-sm text-blue-700 font-semibold">Note for Page Owner:</p>
                <p class="text-xs text-blue-600">To enable submissions, create a Google Form linked to your spreadsheet. Then, replace `YOUR_FORM_ACTION_URL` in the JavaScript with your form's action URL, and update each `entry.YOUR_..._FIELD_ID` in the HTML `name` attributes above with the correct entry IDs from your Google Form (found by inspecting the "name" attribute of inputs in your live Google Form).</p>
            </div>
        </section>

        <section id="communityStatsSection" class="mb-8 md:mb-12 stat-card">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-6">Community Heirloom Statistics üìä</h2>
            <p class="mb-4 text-slate-700">Statistics based on data submitted by the community. This helps visualize how players are getting their Heirloom Shards.</p>
            <button id="refreshStatsButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm mb-6">Load/Refresh Community Stats</button>
            
            <div id="communityStatsResults" class="hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-indigo-50 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-indigo-500">Total Submissions</h4>
                        <p id="statsTotalSubmissions" class="text-2xl font-bold text-indigo-700">-</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-indigo-500">Avg. Packs When Received</h4>
                        <p id="statsAvgPacks" class="text-2xl font-bold text-indigo-700">-</p>
                    </div>
                    <div class="p-4 bg-indigo-50 rounded-lg text-center">
                        <h4 class="text-sm font-medium text-indigo-500">% Hit Pity (500 Packs)</h4>
                        <p id="statsPercentPity" class="text-2xl font-bold text-indigo-700">-</p>
                    </div>
                </div>
                <div class="chart-container bg-white p-1 md:p-2 rounded-lg shadow-inner h-64 md:h-80 max-w-2xl mt-4">
                    <canvas id="communityPackDistributionChart"></canvas>
                </div>
            </div>
             <p id="communityStatsStatus" class="mt-4 text-sm"></p>
            <div class="info-box mt-6">
                <p class="text-sm text-blue-700 font-semibold">Note for Page Owner:</p>
                <p class="text-xs text-blue-600">To enable statistics, publish your Google Sheet (the one linked to your form) to the web as a CSV. Then, replace `YOUR_PUBLISHED_CSV_URL` in the JavaScript with this public CSV link.</p>
            </div>
        </section>

        <section id="systemExplanation" class="mb-8 md:mb-12">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6">Understanding the Odds üé≤</h2>
            <p class="mb-6 text-slate-700">Heirloom Shards are rare, but a system is in place to eventually guarantee them. Here's a breakdown of the core mechanics based on official information and the provided report.</p>
            <div class="space-y-6">
                <div class="stat-card">
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">The 0.045% Random Drop Rate</h3>
                    <p class="text-slate-600">Each regular Apex Pack has a 0.045% chance of containing 150 Heirloom Shards. This is approximately a 1 in 2,222 chance per pack. This chance is independent for each pack you open, until the pity system kicks in.</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">The 500-Pack Pity System üõ°Ô∏è</h3>
                    <p class="text-slate-600">Apex Legends guarantees you will receive 150 Heirloom Shards in your 500th regular Apex Pack IF you haven't received them from a random drop in the previous 499 packs. Once you receive Heirloom Shards (either randomly or via pity), this 500-pack counter resets.</p>
                </div>
                <div class="stat-card">
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">Collection Event Heirlooms</h3>
                    <p class="text-slate-600">If you obtain an Heirloom by purchasing all items in a Collection Event, this <span class="font-bold">does not</span> reset your 500-pack pity counter for Heirloom Shards from regular Apex Packs. These are considered separate acquisition methods.</p>
                </div>
            </div>
        </section>

        <section id="probabilityVisualized" class="mb-8 md:mb-12">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6">Probability Visualized üìä</h2>
            <p class="mb-6 text-slate-700">This chart shows the cumulative probability of receiving Heirloom Shards as you open more regular Apex Packs. The line dramatically increases towards 100% as you approach the 500-pack pity limit. Your current estimated pack count (from the tracker above) will be highlighted on the chart once you calculate your progress.</p>
            <div class="chart-container bg-white p-4 rounded-lg shadow-md h-72 md:h-96 max-w-3xl">
                <canvas id="probabilityChart"></canvas>
            </div>
             <div id="chartTooltip" class="tooltip"></div>
        </section>

        <section id="keyInsights" class="mb-8 md:mb-12">
            <h2 class="text-2xl font-semibold text-sky-600 mb-6">Key Insights & Why Still No Shards? ü§î</h2>
            <p class="mb-6 text-slate-700">Based on the detailed analysis provided in the source report, here are some key takeaways if you're wondering why you haven't received Heirloom Shards yet:</p>
            <div class="space-y-4">
                <div class="p-4 bg-sky-50 border border-sky-200 rounded-md">
                    <h3 class="font-semibold text-slate-700">It's Statistically Normal (Usually)</h3>
                    <p class="text-slate-600 text-sm">With a 0.045% chance per pack, it's common to open hundreds of packs without a random drop. For example, after 219 packs, there's still a ~90.6% chance you *wouldn't* have received them randomly. Your experience is likely typical unless you are very close to or past the 500-pack mark.</p>
                </div>
                <div class="p-4 bg-sky-50 border border-sky-200 rounded-md">
                    <h3 class="font-semibold text-slate-700">Patience or Pity</h3>
                    <p class="text-slate-600 text-sm">Heirloom Shards are a long-term goal. Most players will get them via the 500-pack pity system rather than extreme luck. The calculator above helps you see how far you have to go for that guarantee.</p>
                </div>
                <div class="p-4 bg-sky-50 border border-sky-200 rounded-md">
                    <h3 class="font-semibold text-slate-700">Track Your Packs</h3>
                    <p class="text-slate-600 text-sm">While there's no official in-game counter, keeping a rough estimate (especially of purchased packs and fully completed Battle Pass packs) helps you know your progress towards the pity limit.</p>
                </div>
            </div>
        </section>


        <footer class="text-center pt-8 mt-8 border-t border-slate-200">
            <p class="text-sm text-slate-500">This analyzer is based on publicly available information and community data. It provides estimates and explanations for informational purposes.</p>
            <p class="text-xs text-slate-400 mt-1">Apex Legends is a trademark of Electronic Arts Inc.</p>
        </footer>
    </div>

    <script>
        // --- Existing Calculator JavaScript ---
        const playerLevelInput = document.getElementById('playerLevel');
        const purchasedPacksInput = document.getElementById('purchasedPacks');
        const otherPacksInput = document.getElementById('otherPacks');
        const calculateButton = document.getElementById('calculateButton');
        const resultsDiv = document.getElementById('results');
        const packsFromLevelEl = document.getElementById('packsFromLevel');
        const totalPacksOpenedEl = document.getElementById('totalPacksOpened');
        const progressBarFillEl = document.getElementById('progressBarFill');
        const packsToPityEl = document.getElementById('packsToPity');
        const randomChanceTextEl = document.getElementById('randomChanceText');
        
        const probabilityChartCanvas = document.getElementById('probabilityChart');
        const chartTooltipEl = document.getElementById('chartTooltip');
        let probabilityChart;

        const HEIRLOOM_PITY_CAP = 500;
        const HEIRLOOM_CHANCE_PER_PACK = 0.00045;

        function calculatePacksFromPlayerLevel(level) {
            if (level <= 1) return 0;
            let packs = 0;
            if (level <= 20) {
                packs = level - 1;
            } else {
                packs = 19; 
                if (level <= 300) { 
                    packs += Math.floor((level - 22) / 2) + 1;
                } else { 
                    packs += Math.floor((300 - 22) / 2) + 1; 
                    if (level >= 305) { 
                         packs += Math.floor((Math.min(level, 500) - 305) / 5) + 1;
                    }
                }
            }
            return packs;
        }

        function updateResults() {
            const level = parseInt(playerLevelInput.value) || 0;
            const purchasedPacks = parseInt(purchasedPacksInput.value) || 0;
            const otherPacks = parseInt(otherPacksInput.value) || 0;
            const packsFromLevel = calculatePacksFromPlayerLevel(level);
            const totalPacks = packsFromLevel + purchasedPacks + otherPacks;
            
            packsFromLevelEl.textContent = packsFromLevel;
            totalPacksOpenedEl.textContent = totalPacks;
            const progressPercent = Math.min((totalPacks / HEIRLOOM_PITY_CAP) * 100, 100);
            progressBarFillEl.style.width = progressPercent + '%';
            progressBarFillEl.textContent = Math.round(progressPercent) + '%';
            const packsRemaining = Math.max(0, HEIRLOOM_PITY_CAP - totalPacks);
            packsToPityEl.innerHTML = `You are <span class="font-bold">${packsRemaining}</span> regular Apex Packs away from the guarantee.`;
            const cumulativeChanceOfNotGetting = Math.pow((1 - HEIRLOOM_CHANCE_PER_PACK), totalPacks);
            const cumulativeChanceOfGetting = (1 - cumulativeChanceOfNotGetting) * 100;
            if (totalPacks >= HEIRLOOM_PITY_CAP) {
                 randomChanceTextEl.textContent = `You have reached or exceeded the 500-pack pity limit! You are guaranteed Heirloom Shards if you haven't received them.`;
            } else {
                 randomChanceTextEl.textContent = `Based on ${totalPacks} packs, you've had approximately a ${cumulativeChanceOfGetting.toFixed(2)}% chance of randomly receiving Heirloom Shards by now. Remember, the 500-pack pity is your ultimate guarantee.`;
            }
            resultsDiv.classList.remove('hidden');
            updateChartHighlight(totalPacks);
        }
        
        calculateButton.addEventListener('click', updateResults);

        function generateChartData() {
            const labels = [];
            const data = [];
            for (let i = 0; i <= HEIRLOOM_PITY_CAP; i++) {
                labels.push(i);
                if (i < HEIRLOOM_PITY_CAP) {
                    data.push((1 - Math.pow((1 - HEIRLOOM_CHANCE_PER_PACK), i)) * 100);
                } else {
                    data.push(100);
                }
            }
            return { labels, data };
        }

        function initializeChart() {
            const { labels, data } = generateChartData();
            const ctx = probabilityChartCanvas.getContext('2d');
            Chart.defaults.font.family = "'Inter', sans-serif";
            probabilityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative Chance of Getting Heirloom Shards (%)',
                        data: data,
                        borderColor: '#0284c7',
                        backgroundColor: 'rgba(2, 132, 199, 0.1)',
                        tension: 0.1, fill: true, pointRadius: 0, pointHitRadius: 10, 
                    }, {
                        label: 'Your Current Progress', data: [], borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b', pointRadius: 5, pointHoverRadius: 7,
                        showLine: false, type: 'scatter', 
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Regular Apex Packs Opened', font: { weight: '600'}},
                            ticks: { maxTicksLimit: 11, callback: function(v) { if (v % 50 === 0 || v === HEIRLOOM_PITY_CAP) return v;}}},
                        y: { title: { display: true, text: 'Cumulative Probability (%)', font: { weight: '600'}}, min: 0, max: 100, ticks: { callback: function(v) { return v + '%' }}}
                    },
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 12 }}},
                        tooltip: { enabled: false, external: function(c) {
                            const m = c.tooltip; if (m.opacity===0){ chartTooltipEl.style.opacity='0'; return; }
                            chartTooltipEl.style.opacity='1'; chartTooltipEl.style.left=m.caretX+'px';
                            chartTooltipEl.style.top=probabilityChartCanvas.getBoundingClientRect().top+window.scrollY+m.caretY-chartTooltipEl.offsetHeight-5+'px';
                            if(m.body){ const p=m.dataPoints[0].label; const h=parseFloat(m.dataPoints[0].raw).toFixed(2); chartTooltipEl.innerHTML=`Packs: ${p}<br>Chance: ${h}%`;}}
                        }
                    },
                    interaction: { mode: 'index', intersect: false }, hover: { mode: 'nearest', intersect: true }, animation: { duration: 300 }
                }
            });
        }

        function updateChartHighlight(currentPacks) {
            if (!probabilityChart) return;
            currentPacks = Math.min(currentPacks, HEIRLOOM_PITY_CAP);
            let chanceAtCurrentPacks = (currentPacks < HEIRLOOM_PITY_CAP) ? (1 - Math.pow((1 - HEIRLOOM_CHANCE_PER_PACK), currentPacks)) * 100 : 100;
            probabilityChart.data.datasets[1].data = [{ x: currentPacks, y: chanceAtCurrentPacks }];
            probabilityChart.update('none');
        }
        
        // --- NEW JavaScript for Community Data Submission & Stats ---
        const heirloomDataForm = document.getElementById('heirloomDataForm');
        const formSubmissionStatusEl = document.getElementById('formSubmissionStatus');
        
        // !!! PAGE OWNER: Replace with your Google Form's action URL !!!
        // Example: const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse';
        const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyM47o18j6jLxN8miqMJBqLnxZlDsj5WOxQ4nQzajPSRhQQYfEzy5S7QQrTywQ_OG6YWSpHmiD8OnX/pub?gid=0&single=true&output=csv'; 

        if (heirloomDataForm) {
            heirloomDataForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                formSubmissionStatusEl.textContent = 'Submitting...';
                formSubmissionStatusEl.className = 'mt-4 text-sm text-amber-600';

                if (GOOGLE_FORM_ACTION_URL === 'YOUR_FORM_ACTION_URL') {
                    formSubmissionStatusEl.textContent = 'Submission system not configured by page owner.';
                    formSubmissionStatusEl.className = 'mt-4 text-sm text-red-600';
                    alert('Page owner needs to configure the Google Form Action URL in the JavaScript code.');
                    return;
                }

                const formData = new FormData(heirloomDataForm);
                try {
                    // Submitting to Google Form via fetch in 'no-cors' mode.
                    // Google Forms don't typically return CORS headers that allow direct inspection of the response from client-side JS.
                    // 'no-cors' means we send the data but can't see the response body or status directly if it's a cross-origin request.
                    // The submission should still go through if the URL and field names are correct.
                    await fetch(GOOGLE_FORM_ACTION_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Important for submitting to Google Forms to avoid CORS errors
                        body: formData,
                    });
                    formSubmissionStatusEl.textContent = 'Data submitted successfully! Thank you for contributing.';
                    formSubmissionStatusEl.className = 'mt-4 text-sm text-green-600';
                    heirloomDataForm.reset();
                } catch (error) {
                    console.error('Error submitting to Google Form:', error);
                    formSubmissionStatusEl.textContent = 'Submission failed. Please try again. (See console for details)';
                    formSubmissionStatusEl.className = 'mt-4 text-sm text-red-600';
                }
            });
        }

        const refreshStatsButton = document.getElementById('refreshStatsButton');
        const communityStatsResultsEl = document.getElementById('communityStatsResults');
        const communityStatsStatusEl = document.getElementById('communityStatsStatus');
        const statsTotalSubmissionsEl = document.getElementById('statsTotalSubmissions');
        const statsAvgPacksEl = document.getElementById('statsAvgPacks');
        const statsPercentPityEl = document.getElementById('statsPercentPity');
        const communityPackDistributionCanvas = document.getElementById('communityPackDistributionChart');
        let communityPackDistributionChart;

        // !!! PAGE OWNER: Replace with your Published Google Sheet CSV URL !!!
        // Example: const PUBLISHED_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_ID/pub?gid=YOUR_GID&single=true&output=csv';
        const PUBLISHED_CSV_URL = 'YOUR_PUBLISHED_CSV_URL';

        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/);
            const headers = lines[0].split(',');
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const values = lines[i].split(',');
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header.trim()] = values[index] ? values[index].trim() : '';
                });
                data.push(entry);
            }
            return data;
        }
        
        async function loadCommunityStats() {
            communityStatsStatusEl.textContent = 'Loading community stats...';
            communityStatsStatusEl.className = 'mt-4 text-sm text-amber-600';

            if (PUBLISHED_CSV_URL === 'YOUR_PUBLISHED_CSV_URL') {
                 communityStatsStatusEl.textContent = 'Community stats system not configured by page owner.';
                 communityStatsStatusEl.className = 'mt-4 text-sm text-red-600';
                 alert('Page owner needs to configure the Published CSV URL in the JavaScript code.');
                 return;
            }

            try {
                const response = await fetch(PUBLISHED_CSV_URL);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.status} ${response.statusText}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    communityStatsStatusEl.textContent = 'No community data found or sheet is empty.';
                    communityStatsStatusEl.className = 'mt-4 text-sm text-slate-600';
                    communityStatsResultsEl.classList.add('hidden');
                    return;
                }

                // --- !! IMPORTANT !! ---
                // Adjust these column names to match EXACTLY how they appear as headers in your published CSV file.
                const PACKS_COLUMN_NAME = 'Estimated Total Packs Opened When Shards Received'; // Example, adjust to your CSV header
                const PITY_COLUMN_NAME = 'Did you hit the 500-pack pity guarantee?'; // Example, adjust to your CSV header

                let totalSubmissions = data.length;
                let sumOfPacks = 0;
                let pityCount = 0;
                const packDistribution = {}; // For histogram data {packCount: frequency}

                data.forEach(entry => {
                    const packs = parseInt(entry[PACKS_COLUMN_NAME]);
                    if (!isNaN(packs) && packs > 0) {
                        sumOfPacks += packs;
                        packDistribution[packs] = (packDistribution[packs] || 0) + 1;
                    }
                    if (entry[PITY_COLUMN_NAME] && entry[PITY_COLUMN_NAME].toLowerCase() === 'yes') {
                        pityCount++;
                    } else if (!isNaN(packs) && packs >= HEIRLOOM_PITY_CAP) { 
                        // If pity column is not "Yes" but packs are >= 500, count as pity for this stat.
                        // This assumes the "Packs" column is reliable.
                        pityCount++;
                    }
                });

                statsTotalSubmissionsEl.textContent = totalSubmissions;
                statsAvgPacksEl.textContent = totalSubmissions > 0 ? (sumOfPacks / totalSubmissions).toFixed(1) : '-';
                statsPercentPityEl.textContent = totalSubmissions > 0 ? ((pityCount / totalSubmissions) * 100).toFixed(1) + '%' : '-';
                
                communityStatsResultsEl.classList.remove('hidden');
                communityStatsStatusEl.textContent = `Stats loaded successfully from ${totalSubmissions} submissions.`;
                communityStatsStatusEl.className = 'mt-4 text-sm text-green-600';

                // Update or create community pack distribution chart
                const distributionLabels = Object.keys(packDistribution).map(Number).sort((a, b) => a - b);
                const distributionData = distributionLabels.map(label => packDistribution[label]);

                if (communityPackDistributionChart) {
                    communityPackDistributionChart.data.labels = distributionLabels;
                    communityPackDistributionChart.data.datasets[0].data = distributionData;
                    communityPackDistributionChart.update();
                } else {
                    const ctx = communityPackDistributionCanvas.getContext('2d');
                    communityPackDistributionChart = new Chart(ctx, {
                        type: 'bar', // Or 'line' if preferred for distribution
                        data: {
                            labels: distributionLabels,
                            datasets: [{
                                label: 'Frequency of Shards at Pack Count',
                                data: distributionData,
                                backgroundColor: 'rgba(79, 70, 229, 0.6)', // indigo-500 with alpha
                                borderColor: 'rgba(79, 70, 229, 1)', // indigo-500
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                x: { title: { display: true, text: 'Packs Opened When Shards Received', font: { weight: '600' } } },
                                y: { title: { display: true, text: 'Number of Players (Frequency)', font: { weight: '600' } }, beginAtZero: true, ticks: { stepSize: 1 } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading community stats:', error);
                communityStatsStatusEl.textContent = `Failed to load stats. ${error.message}`;
                communityStatsStatusEl.className = 'mt-4 text-sm text-red-600';
                communityStatsResultsEl.classList.add('hidden');
            }
        }

        if (refreshStatsButton) {
            refreshStatsButton.addEventListener('click', loadCommunityStats);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart(); // Initializes the personal probability chart
            // You might want to automatically load community stats on page load, or not.
            // loadCommunityStats(); // Uncomment to load stats automatically
        });

    </script>
</body>
</html>
